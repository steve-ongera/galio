<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    {% load static %}
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="meta description">

    <title>{% block title %}checkout{% endblock %}</title>

    <link rel="shortcut icon" href="{% static 'assets/img/logo/logo2.png' %}" type="image/x-icon" />

    <!-- CSS Files -->
    <link href="{% static 'assets/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'assets/css/font-awesome.min.css' %}" rel="stylesheet">
    <link href="{% static 'assets/css/helper.min.css' %}" rel="stylesheet">
    <link href="{% static 'assets/css/plugins.css' %}" rel="stylesheet">
    <link href="{% static 'assets/css/style.css' %}" rel="stylesheet">
    <link href="{% static 'assets/css/skin-default.css' %}" rel="stylesheet" id="galio-skin">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        /* Enhanced M-Pesa Modal Styles */
        #mpesaModal .modal-dialog {
            max-width: 500px;
        }
        
        #mpesaModal .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        
        #mpesaModal .modal-header {
            background: linear-gradient(135deg, #1e7e34 0%, #28a745 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 20px;
            border: none;
        }
        
        #mpesaModal .modal-title {
            font-weight: 600;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #mpesaModal .modal-body {
            padding: 30px;
            text-align: center;
        }
        
        /* Loading Animation */
        .payment-loader {
            margin: 20px auto;
            width: 80px;
            height: 80px;
            position: relative;
        }
        
        .payment-loader .spinner {
            width: 80px;
            height: 80px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .payment-icon {
            font-size: 60px;
            margin: 20px 0;
        }
        
        .payment-icon.pending {
            color: #ffc107;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .payment-icon.success {
            color: #28a745;
            animation: bounceIn 0.6s;
        }
        
        .payment-icon.failed {
            color: #dc3545;
            animation: shake 0.5s;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .payment-message {
            font-size: 1.1rem;
            margin: 15px 0;
            line-height: 1.6;
        }
        
        .payment-message.pending {
            color: #6c757d;
        }
        
        .payment-message.success {
            color: #28a745;
            font-weight: 600;
        }
        
        .payment-message.failed {
            color: #dc3545;
            font-weight: 600;
        }
        
        .payment-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 0.95rem;
        }
        
        .payment-details .detail-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .payment-details .detail-row:last-child {
            border-bottom: none;
        }
        
        .payment-details .detail-label {
            color: #6c757d;
            font-weight: 500;
        }
        
        .payment-details .detail-value {
            color: #212529;
            font-weight: 600;
        }
        
        .modal-footer {
            border-top: none;
            padding: 15px 30px 30px;
            justify-content: center;
        }
        
        .btn-close-modal {
            padding: 10px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        /* Progress dots */
        .progress-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
        }
        
        .progress-dot {
            width: 10px;
            height: 10px;
            background: #dee2e6;
            border-radius: 50%;
            animation: dotPulse 1.5s ease-in-out infinite;
        }
        
        .progress-dot:nth-child(1) { animation-delay: 0s; }
        .progress-dot:nth-child(2) { animation-delay: 0.3s; }
        .progress-dot:nth-child(3) { animation-delay: 0.6s; }
        
        @keyframes dotPulse {
            0%, 100% { background: #dee2e6; transform: scale(1); }
            50% { background: #28a745; transform: scale(1.3); }
        }
        
        /* Mobile phone illustration */
        .phone-illustration {
            width: 100px;
            height: 180px;
            margin: 20px auto;
            position: relative;
            border: 3px solid #212529;
            border-radius: 20px;
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .phone-screen {
            position: absolute;
            top: 15px;
            left: 10px;
            right: 10px;
            bottom: 30px;
            background: linear-gradient(180deg, #28a745 0%, #1e7e34 100%);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }
        
        .phone-notch {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 6px;
            background: #212529;
            border-radius: 3px;
        }
        
        .phone-button {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 30px;
            border: 2px solid #212529;
            border-radius: 50%;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>

<body>
    <div class="wrapper">
        <!-- header area start -->
        <header>
            {% include 'partials/header.html' %}
        </header>
        
        
         <!-- breadcrumb area start -->
            <div class="breadcrumb-area">
                <div class="container">
                    <div class="row">
                        <div class="col-12">
                            <div class="breadcrumb-wrap">
                                <nav aria-label="breadcrumb">
                                    <ul class="breadcrumb">
                                        <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
                                        <li class="breadcrumb-item"><a href="{% url 'cart' %}">Cart</a></li>
                                        <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- breadcrumb area end -->

            <!-- checkout main wrapper start -->
            <div class="checkout-page-wrapper">
                <div class="container">
                    <div class="row">
                        <div class="col-12">
                            <!-- Display Messages -->
                            {% if messages %}
                                {% for message in messages %}
                                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                {% endfor %}
                            {% endif %}

                        

                            <!-- Checkout Login Coupon Accordion Start -->
                            <div class="checkoutaccordion" id="checkOutAccordion">
                                {% if not user.is_authenticated %}
                                <div class="card">
                                    <h3>Returning Customer? <span data-toggle="collapse" data-target="#logInaccordion">Click Here To Login</span></h3>
                                    <div id="logInaccordion" class="collapse" data-parent="#checkOutAccordion">
                                        <div class="card-body">
                                            <p>If you have shopped with us before, please enter your details in the boxes below. If you are a new customer, please proceed to the Billing &amp; Shipping section.</p>
                                            <div class="login-reg-form-wrap mt-20">
                                                <div class="row">
                                                    <div class="col-lg-7 m-auto">
                                                        <form action="{% url 'login' %}" method="post">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="next" value="{% url 'checkout' %}">
                                                            <div class="row">
                                                                <div class="col-md-12">
                                                                    <div class="single-input-item">
                                                                        <input type="email" name="email" placeholder="Enter your Email" required />
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-12">
                                                                    <div class="single-input-item">
                                                                        <input type="password" name="password" placeholder="Enter your Password" required />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="single-input-item">
                                                                <div class="login-reg-form-meta d-flex align-items-center justify-content-between">
                                                                    <div class="remember-meta">
                                                                        <div class="custom-control custom-checkbox">
                                                                            <input type="checkbox" class="custom-control-input" id="rememberMe" name="rememberMe" />
                                                                            <label class="custom-control-label" for="rememberMe">Remember Me</label>
                                                                        </div>
                                                                    </div>
                                                                    <a href="{% url 'password_reset' %}" class="forget-pwd">Forget Password?</a>
                                                                </div>
                                                            </div>
                                                            <div class="single-input-item">
                                                                <button type="submit" class="check-btn sqr-btn">Login</button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <div class="card">
                                    <h3>Have A Coupon? <span data-toggle="collapse" data-target="#couponaccordion">Click Here To Enter Your Code</span></h3>
                                    <div id="couponaccordion" class="collapse" data-parent="#checkOutAccordion">
                                        <div class="card-body">
                                            <div class="cart-update-option">
                                                <div class="apply-coupon-wrapper">
                                                    <form action="{% url 'apply_coupon' %}" method="post" class="d-block d-md-flex">
                                                        {% csrf_token %}
                                                        <input type="text" name="coupon_code" placeholder="Enter Your Coupon Code" required />
                                                        <button type="submit" class="check-btn sqr-btn">Apply Coupon</button>
                                                    </form>
                                                    {% if request.session.coupon_code %}
                                                        <div class="mt-2">
                                                            <span class="badge badge-success">Coupon "{{ request.session.coupon_code }}" applied</span>
                                                            <a href="{% url 'remove_coupon' %}" class="btn btn-sm btn-outline-danger ml-2">Remove</a>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Checkout Login Coupon Accordion End -->
                        </div>
                    </div>

                    <form method="post" id="checkout-form" novalidate>
                        {% csrf_token %}
                        <div class="row">
                            <!-- Checkout Billing Details -->
                            <div class="col-lg-6">
                                <div class="checkout-billing-details-wrap">
                                    <h2>Billing Details</h2>
                                    <div class="billing-form-wrap">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="single-input-item">
                                                    <label for="id_billing-first_name" class="required">First Name</label>
                                                    <input type="text" name="billing-first_name" id="id_billing-first_name" class="form-control" required>
                                                    {% if billing_form.first_name.errors %}
                                                        <div class="invalid-feedback">{{ billing_form.first_name.errors.0 }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="single-input-item">
                                                    <label for="id_billing-last_name" class="required">Last Name</label>
                                                    <input type="text" name="billing-last_name" id="id_billing-last_name" class="form-control" required>
                                                    {% if billing_form.last_name.errors %}
                                                        <div class="invalid-feedback">{{ billing_form.last_name.errors.0 }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>

                                        <div class="single-input-item">
                                            <label for="id_billing-email" class="required">Email Address</label>
                                            <input type="email" name="billing-email" id="id_billing-email" class="form-control" required>
                                            {% if billing_form.email.errors %}
                                                <div class="invalid-feedback">{{ billing_form.email.errors.0 }}</div>
                                            {% endif %}
                                        </div>

                                        <div class="single-input-item">
                                            <label for="id_billing-phone" class="required">Phone</label>
                                            <input type="tel" name="billing-phone" id="id_billing-phone" placeholder="+254712345678" class="form-control" required>
                                            <small class="form-text text-muted">Required for delivery coordination</small>
                                            {% if billing_form.phone.errors %}
                                                <div class="invalid-feedback">{{ billing_form.phone.errors.0 }}</div>
                                            {% endif %}
                                        </div>

                                        <div class="single-input-item">
                                            <label for="id_billing-county" class="required">County</label>
                                            <select name="billing-county" id="id_billing-county" class="form-control county-select" required>
                                                <option value="">Select County</option>
                                                {% for county in counties %}
                                                    <option value="{{ county.id }}">{{ county.name }}</option>
                                                {% endfor %}
                                            </select>
                                            {% if billing_form.county.errors %}
                                                <div class="invalid-feedback">{{ billing_form.county.errors.0 }}</div>
                                            {% endif %}
                                        </div>

                                        <div class="single-input-item">
                                            <label for="id_billing-delivery_area" class="required">Delivery Area</label>
                                            <select name="billing-delivery_area" id="id_billing-delivery_area" class="form-control area-select" required>
                                                <option value="">Select County First</option>
                                            </select>
                                            <small class="form-text text-muted">Shipping fee will be calculated based on your area</small>
                                            {% if billing_form.delivery_area.errors %}
                                                <div class="invalid-feedback">{{ billing_form.delivery_area.errors.0 }}</div>
                                            {% endif %}
                                        </div>

                                        <div class="single-input-item">
                                            <label for="id_billing-detailed_address" class="required">Detailed Address</label>
                                            <textarea name="billing-detailed_address" id="id_billing-detailed_address" class="form-control" rows="3" 
                                                placeholder="Building name, floor, apartment number, landmarks...&#10;Example: ABC Apartments, 2nd Floor, House No. 5B, Near Shell Petrol Station" required></textarea>
                                            <small class="form-text text-muted">Please provide specific details to help our delivery team find you</small>
                                            {% if billing_form.detailed_address.errors %}
                                                <div class="invalid-feedback">{{ billing_form.detailed_address.errors.0 }}</div>
                                            {% endif %}
                                        </div>

                                        {% if not user.is_authenticated %}
                                        <div class="checkout-box-wrap">
                                            <div class="single-input-item">
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" class="custom-control-input" id="create_pwd" name="create_pwd">
                                                    <label class="custom-control-label" for="create_pwd">Create an account?</label>
                                                </div>
                                            </div>
                                            <div class="account-create single-form-row" id="password-field" style="display: none;">
                                                <p>Create an account by entering the information below. If you are a returning customer please login at the top of the page.</p>
                                                <div class="single-input-item">
                                                    <label for="pwd" class="required">Account Password</label>
                                                    <input type="password" id="pwd" name="pwd" placeholder="Account Password" class="form-control" />
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <div class="checkout-box-wrap">
                                            <div class="single-input-item">
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" class="custom-control-input" id="ship_to_different" name="ship_to_different">
                                                    <label class="custom-control-label" for="ship_to_different">Ship to a different address?</label>
                                                </div>
                                            </div>
                                            <div class="ship-to-different single-form-row" id="shipping-fields" style="display: none;">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="single-input-item">
                                                            <label for="id_shipping-first_name" class="required">First Name</label>
                                                            <input type="text" name="shipping-first_name" id="id_shipping-first_name" class="form-control">
                                                            {% if shipping_form.first_name.errors %}
                                                                <div class="invalid-feedback">{{ shipping_form.first_name.errors.0 }}</div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="single-input-item">
                                                            <label for="id_shipping-last_name" class="required">Last Name</label>
                                                            <input type="text" name="shipping-last_name" id="id_shipping-last_name" class="form-control">
                                                            {% if shipping_form.last_name.errors %}
                                                                <div class="invalid-feedback">{{ shipping_form.last_name.errors.0 }}</div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="single-input-item">
                                                    <label for="id_shipping-phone" class="required">Phone</label>
                                                    <input type="tel" name="shipping-phone" id="id_shipping-phone" placeholder="+254712345678" class="form-control">
                                                </div>
                                                

                                                <div class="single-input-item">
                                                    <label for="id_shipping-county" class="required">County</label>
                                                    <select name="shipping-county" id="id_shipping-county" class="form-control county-select">
                                                        <option value="">Select County</option>
                                                        {% for county in counties %}
                                                            <option value="{{ county.id }}">{{ county.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <div class="single-input-item">
                                                    <label for="id_shipping-delivery_area" class="required">Delivery Area</label>
                                                    <select name="shipping-delivery_area" id="id_shipping-delivery_area" class="form-control area-select">
                                                        <option value="">Select County First</option>
                                                    </select>
                                                </div>

                                                <div class="single-input-item">
                                                    <label for="id_shipping-detailed_address" class="required">Detailed Address</label>
                                                    <textarea name="shipping-detailed_address" id="id_shipping-detailed_address" class="form-control" rows="3" 
                                                        placeholder="Building name, floor, apartment number, landmarks..."></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="single-input-item">
                                            <label for="ordernote">Order Note</label>
                                            <textarea name="ordernote" id="ordernote" cols="30" rows="3" placeholder="Notes about your order, e.g. special notes for delivery." class="form-control"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Order Summary Details -->
                            <div class="col-lg-6">
                                <div class="order-summary-details mt-md-26 mt-sm-26">
                                    <h2>Your Order Summary</h2>
                                    <div class="order-summary-content mb-sm-4">
                                        <!-- Order Summary Table -->
                                        <div class="order-summary-table table-responsive text-center">
                                            <table class="table table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>Products</th>
                                                        <th>Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for item in cart_items %}
                                                    <tr>
                                                        <td>
                                                            <a href="#">
                                                            {{ item.product.name|slice:":15" }}{% if item.product.name|length > 15 %}...{% endif %}
                                                                {% if item.variant %}
                                                                    ({{ item.variant.name }})
                                                                {% endif %}
                                                                <strong> Ã— {{ item.quantity }}</strong>
                                                            </a>
                                                        </td>
                                                        <td>KSh {{ item.total_price|floatformat:2 }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                                <tfoot id="order-summary-footer">
                                                    <tr>
                                                        <td>Sub Total</td>
                                                        <td><strong>KSh <span id="subtotal-amount">{{ subtotal|floatformat:2 }}</span></strong></td>
                                                    </tr>
                                                    <tr>
                                                        <td>Shipping <span id="shipping-info"></span></td>
                                                        <td><strong>KSh <span id="shipping-amount">{{ shipping_cost|floatformat:2 }}</span></strong></td>
                                                    </tr>
                                                    <tr>
                                                        <td>Tax (0%)</td>
                                                        <td><strong>KSh <span id="tax-amount">{{ tax_amount|floatformat:2 }}</span></strong></td>
                                                    </tr>
                                                    {% if request.session.coupon_code %}
                                                    <tr id="discount-row">
                                                        <td>Discount</td>
                                                        <td><strong>-KSh <span id="discount-amount">0.00</span></strong></td>
                                                    </tr>
                                                    {% else %}
                                                    <tr id="discount-row" style="display: none;">
                                                        <td>Discount</td>
                                                        <td><strong>-KSh <span id="discount-amount">0.00</span></strong></td>
                                                    </tr>
                                                    {% endif %}
                                                    <tr>
                                                        <td>Total Amount</td>
                                                        <td><strong>KSh <span id="total-amount">{{ total_amount|floatformat:2 }}</span></strong></td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>

                                        <!-- Order Payment Method -->
                                        <div class="order-payment-method">
                                            <div class="single-payment-method show">
                                                <div class="payment-method-name">
                                                    <div class="custom-control custom-radio">
                                                        <input type="radio" id="cashon" name="paymentmethod" value="cash" class="custom-control-input" />
                                                        <label class="custom-control-label" for="cashon">Cash On Delivery</label>
                                                    </div>
                                                </div>
                                                <div class="payment-method-details" data-method="cash">
                                                    <p>Pay with cash upon delivery.</p>
                                                </div>
                                            </div>
                                            
                                            <div class="single-payment-method">
                                                <div class="payment-method-name">
                                                    <div class="custom-control custom-radio">
                                                        <input type="radio" id="mpesa" name="paymentmethod" value="mpesa" class="custom-control-input" checked />
                                                        <label class="custom-control-label" for="mpesa">M-Pesa Payment</label>
                                                    </div>
                                                </div>
                                                <div class="payment-method-details" data-method="mpesa">
                                                    <p>Pay using M-Pesa. You will receive an STK push notification on your phone.</p>
                                                </div>
                                            </div>

                                            <div class="single-payment-method">
                                                <div class="payment-method-name">
                                                    <div class="custom-control custom-radio">
                                                        <input type="radio" id="directbank" name="paymentmethod" value="bank" class="custom-control-input" />
                                                        <label class="custom-control-label" for="directbank">Direct Bank Transfer</label>
                                                    </div>
                                                </div>
                                                <div class="payment-method-details" data-method="bank">
                                                    <p>Make your payment directly into our bank account. Please use your Order ID as the payment reference.</p>
                                                </div>
                                            </div>

                                            <div class="summary-footer-area">
                                                <div class="custom-control custom-checkbox mb-14">
                                                    <input type="checkbox" class="custom-control-input" id="terms" required />
                                                    <label class="custom-control-label" for="terms">I have read and agree to the website <a href="#">terms and conditions.</a></label>
                                                </div>
                                                <button type="submit" class="check-btn sqr-btn" id="place-order-btn">Place Order</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <!-- checkout main wrapper end -->

        <!-- Enhanced M-Pesa Payment Modal -->
        <div class="modal fade" id="mpesaModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-phone-fill"></i>
                            M-Pesa Payment
                        </h5>
                    </div>
                    <div class="modal-body">
                        <!-- Loading State -->
                        <div id="payment-loading" style="display: none;">
                            <div class="payment-loader">
                                <div class="spinner"></div>
                            </div>
                            <p class="payment-message pending">Initiating payment...</p>
                        </div>
                        
                        <!-- Pending State -->
                        <div id="payment-pending" style="display: none;">
                            <div class="phone-illustration">
                                <div class="phone-notch"></div>
                                <div class="phone-screen">
                                    <i class="bi bi-lock-fill" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                    <div>M-PESA</div>
                                    <div style="font-size: 0.7rem; margin-top: 5px;">Enter PIN</div>
                                </div>
                                <div class="phone-button"></div>
                            </div>
                            <p class="payment-message pending">
                                <strong>Check your phone</strong><br>
                                Enter your M-Pesa PIN to complete payment
                            </p>
                            <div class="progress-dots">
                                <div class="progress-dot"></div>
                                <div class="progress-dot"></div>
                                <div class="progress-dot"></div>
                            </div>
                            <p style="font-size: 0.9rem; color: #6c757d; margin-top: 15px;">
                                <i class="bi bi-info-circle"></i> Waiting for confirmation...
                            </p>
                        </div>
                        
                        <!-- Success State -->
                        <div id="payment-success" style="display: none;">
                            <i class="bi bi-check-circle-fill payment-icon success"></i>
                            <p class="payment-message success">Payment Successful!</p>
                            <div class="payment-details">
                                <div class="detail-row">
                                    <span class="detail-label">Order Number:</span>
                                    <span class="detail-value" id="success-order-number">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">M-Pesa Receipt:</span>
                                    <span class="detail-value" id="success-receipt">-</span>
                                </div>
                            </div>
                            <p style="font-size: 0.9rem; color: #6c757d;">
                                <i class="bi bi-hourglass-split"></i> Redirecting to order confirmation...
                            </p>
                        </div>
                        
                        <!-- Failed State -->
                        <div id="payment-failed" style="display: none;">
                            <i class="bi bi-x-circle-fill payment-icon failed"></i>
                            <p class="payment-message failed">Payment Failed</p>
                            <p style="font-size: 0.95rem; color: #6c757d;" id="failed-message">
                                The payment could not be processed. Please try again.
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-close-modal" id="modal-close-btn" style="display: none;">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- footer area start -->
        <br>
        <footer>
            {% include 'partials/footer.html' %}
        </footer>
        <!-- footer area end -->
    </div>

    <!-- Scroll to top start -->
    <div class="scroll-top not-visible">
        <i class="fa fa-angle-up"></i>
    </div>
    <!-- Scroll to Top End -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // Global variables
    let countiesData = [];
    let debugEnabled = true;
    let paymentCheckInterval = null;

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        initializeCheckout();
    });

    function initializeCheckout() {
        debug('Starting checkout initialization...');
        
        try {
            countiesData = {{ counties_data|safe }};
            debug('Counties data loaded:', countiesData.length + ' counties');
        } catch (error) {
            debug('Error loading counties data:', error);
            showMessage('Error loading location data. Please refresh the page.', 'error');
            return;
        }
        
        setupEventListeners();
        initializeDeliveryAreas();
        
        debug('Checkout initialization complete');
    }

    function setupEventListeners() {
        debug('Setting up event listeners...');
        
        // Billing address listeners
        const billingCounty = document.getElementById('id_billing-county');
        const billingArea = document.getElementById('id_billing-delivery_area');
        
        if (billingCounty && billingArea) {
            billingArea.disabled = false;
            
            billingCounty.addEventListener('change', function() {
                populateDeliveryAreas('id_billing-county', 'id_billing-delivery_area');
            });
            
            billingArea.addEventListener('change', function() {
                calculateOrderTotals('id_billing-delivery_area', false);
            });
        }
        
        // Shipping address listeners
        const shippingCounty = document.getElementById('id_shipping-county');
        const shippingArea = document.getElementById('id_shipping-delivery_area');
        
        if (shippingCounty && shippingArea) {
            shippingArea.disabled = false;
            
            shippingCounty.addEventListener('change', function() {
                populateDeliveryAreas('id_shipping-county', 'id_shipping-delivery_area');
            });
            
            shippingArea.addEventListener('change', function() {
                calculateOrderTotals('id_shipping-delivery_area', true);
            });
        }
        
        // Ship to different address toggle
        const shipToDifferent = document.getElementById('ship_to_different');
        const shippingFields = document.getElementById('shipping-fields');
        
        if (shipToDifferent && shippingFields) {
            shipToDifferent.addEventListener('change', function() {
                if (this.checked) {
                    shippingFields.style.display = 'block';
                    setFieldsRequired(shippingFields, true);
                } else {
                    shippingFields.style.display = 'none';
                    setFieldsRequired(shippingFields, false);
                    calculateOrderTotals('id_billing-delivery_area', false);
                }
            });
        }
        
        // Create account toggle
        const createAccount = document.getElementById('create_pwd');
        const passwordField = document.getElementById('password-field');
        
        if (createAccount && passwordField) {
            createAccount.addEventListener('change', function() {
                if (this.checked) {
                    passwordField.style.display = 'block';
                    const pwdInput = document.getElementById('pwd');
                    if (pwdInput) pwdInput.required = true;
                } else {
                    passwordField.style.display = 'none';
                    const pwdInput = document.getElementById('pwd');
                    if (pwdInput) pwdInput.required = false;
                }
            });
        }
        
        // Form submission
        const checkoutForm = document.getElementById('checkout-form');
        if (checkoutForm) {
            checkoutForm.addEventListener('submit', handleFormSubmission);
        }
        
        // Modal close button
        const modalCloseBtn = document.getElementById('modal-close-btn');
        if (modalCloseBtn) {
            modalCloseBtn.addEventListener('click', function() {
                $('#mpesaModal').modal('hide');
                location.reload();
            });
        }
    }

    function initializeDeliveryAreas() {
        const billingCounty = document.getElementById('id_billing-county');
        if (billingCounty && billingCounty.value) {
            populateDeliveryAreas('id_billing-county', 'id_billing-delivery_area');
        }
        
        const shippingCounty = document.getElementById('id_shipping-county');
        if (shippingCounty && shippingCounty.value) {
            populateDeliveryAreas('id_shipping-county', 'id_shipping-delivery_area');
        }
    }

    function populateDeliveryAreas(countySelectId, areaSelectId) {
        const countySelect = document.getElementById(countySelectId);
        const areaSelect = document.getElementById(areaSelectId);
        
        if (!countySelect || !areaSelect) return;
        
        const selectedCountyId = countySelect.value;
        areaSelect.innerHTML = '';
        
        if (!selectedCountyId) {
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select County First';
            areaSelect.appendChild(defaultOption);
            areaSelect.disabled = true;
            return;
        }
        
        const countyData = countiesData.find(county => county.id.toString() === selectedCountyId.toString());
        
        if (!countyData || !countyData.areas || countyData.areas.length === 0) {
            const noAreasOption = document.createElement('option');
            noAreasOption.value = '';
            noAreasOption.textContent = 'No delivery areas available';
            areaSelect.appendChild(noAreasOption);
            areaSelect.disabled = true;
            return;
        }
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select Delivery Area';
        areaSelect.appendChild(defaultOption);
        
        countyData.areas.forEach(area => {
            const option = document.createElement('option');
            option.value = area.id;
            option.textContent = area.display_name || area.name;
            option.setAttribute('data-shipping-fee', area.shipping_fee || 0);
            option.setAttribute('data-delivery-days', area.delivery_days || '');
            option.setAttribute('data-area-name', area.name || '');
            areaSelect.appendChild(option);
        });
        
        areaSelect.disabled = false;
    }

    function calculateOrderTotals(areaSelectId, isShipping = false) {
        const areaSelect = document.getElementById(areaSelectId);
        if (!areaSelect) return;
        
        const shipToDifferent = document.getElementById('ship_to_different');
        const shouldUseThisArea = !isShipping || (shipToDifferent && shipToDifferent.checked);
        
        if (!shouldUseThisArea) return;
        
        if (!areaSelect.value) {
            resetOrderTotals();
            return;
        }
        
        const selectedOption = areaSelect.options[areaSelect.selectedIndex];
        if (!selectedOption) {
            resetOrderTotals();
            return;
        }
        
        const shippingFee = parseFloat(selectedOption.getAttribute('data-shipping-fee')) || 0;
        const deliveryDays = selectedOption.getAttribute('data-delivery-days') || '';
        const areaName = selectedOption.getAttribute('data-area-name') || selectedOption.textContent;
        
        const subtotalElement = document.getElementById('subtotal-amount');
        const subtotal = subtotalElement ? parseFloat(subtotalElement.textContent) || 0 : 0;
        
        const taxRate = 0.00;
        const taxAmount = subtotal * taxRate;
        const discountAmount = getDiscountAmount();
        const totalAmount = subtotal + shippingFee + taxAmount - discountAmount;
        
        updateElementText('shipping-amount', shippingFee.toFixed(2));
        updateElementText('tax-amount', taxAmount.toFixed(2));
        updateElementText('total-amount', totalAmount.toFixed(2));
        
        const shippingInfoEl = document.getElementById('shipping-info');
        if (shippingInfoEl) {
            let infoText = `to ${areaName}`;
            if (deliveryDays) {
                const days = parseInt(deliveryDays);
                const dayText = days === 1 ? 'day' : 'days';
                infoText += ` (${days} ${dayText})`;
            }
            shippingInfoEl.textContent = infoText;
        }
    }

    function resetOrderTotals() {
        updateElementText('shipping-amount', '0.00');
        
        const shippingInfoEl = document.getElementById('shipping-info');
        if (shippingInfoEl) {
            shippingInfoEl.textContent = '';
        }
        
        const subtotalEl = document.getElementById('subtotal-amount');
        if (subtotalEl) {
            const subtotal = parseFloat(subtotalEl.textContent) || 0;
            const taxAmount = subtotal * 0.16;
            const discountAmount = getDiscountAmount();
            const totalAmount = subtotal + taxAmount - discountAmount;
            
            updateElementText('tax-amount', taxAmount.toFixed(2));
            updateElementText('total-amount', totalAmount.toFixed(2));
        }
    }

    function getDiscountAmount() {
        const discountEl = document.getElementById('discount-amount');
        return discountEl ? parseFloat(discountEl.textContent) || 0 : 0;
    }

    function updateElementText(elementId, text) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = text;
        }
    }

    function setFieldsRequired(container, required) {
        const fields = container.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], select, textarea');
        fields.forEach(field => {
            const label = field.closest('.single-input-item')?.querySelector('label');
            if (label && label.classList.contains('required')) {
                if (required) {
                    field.setAttribute('required', 'required');
                } else {
                    field.removeAttribute('required');
                }
            }
        });
    }

    function handleFormSubmission(e) {
        debug('Form submission started');
        
        const form = e.target;
        const invalidFields = form.querySelectorAll('.is-invalid');
        invalidFields.forEach(field => field.classList.remove('is-invalid'));
        
        let hasErrors = false;
        
        const requiredFields = form.querySelectorAll('[required]:not([disabled])');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                hasErrors = true;
            }
        });
        
        const termsCheckbox = document.getElementById('terms');
        if (termsCheckbox && !termsCheckbox.checked) {
            showMessage('Please accept the terms and conditions to continue.', 'error');
            hasErrors = true;
        }
        
        const shipToDifferent = document.getElementById('ship_to_different');
        const activeAreaSelect = (shipToDifferent && shipToDifferent.checked) 
            ? document.getElementById('id_shipping-delivery_area')
            : document.getElementById('id_billing-delivery_area');
            
        if (activeAreaSelect && !activeAreaSelect.disabled && !activeAreaSelect.value) {
            activeAreaSelect.classList.add('is-invalid');
            showMessage('Please select a delivery area to calculate shipping costs.', 'error');
            hasErrors = true;
        }
        
        if (hasErrors) {
            e.preventDefault();
            const firstError = form.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
            return false;
        }
        
        const paymentMethod = form.querySelector('input[name="paymentmethod"]:checked');
        if (paymentMethod && paymentMethod.value === 'mpesa') {
            e.preventDefault();
            handleMpesaPayment();
            return false;
        }
        
        return true;
    }

    function handleMpesaPayment() {
        debug('Handling M-Pesa payment');
        
        // Show modal and loading state
        $('#mpesaModal').modal('show');
        showPaymentState('loading');
        
        const form = document.getElementById('checkout-form');
        const formData = new FormData(form);
        
        fetch(form.action || window.location.pathname, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            debug('M-Pesa response:', data);
            
            if (data.success) {
                showPaymentState('pending');
                if (data.checkout_request_id) {
                    startPaymentPolling(data.checkout_request_id);
                }
            } else {
                showPaymentState('failed', data.message);
            }
        })
        .catch(error => {
            debug('Status check error:', error);
            // Don't stop polling on network errors, just log
        });
    }

    function showPaymentState(state, message = '', data = {}) {
        debug('Showing payment state:', state);
        
        // Hide all states
        document.getElementById('payment-loading').style.display = 'none';
        document.getElementById('payment-pending').style.display = 'none';
        document.getElementById('payment-success').style.display = 'none';
        document.getElementById('payment-failed').style.display = 'none';
        document.getElementById('modal-close-btn').style.display = 'none';
        
        // Show appropriate state
        switch(state) {
            case 'loading':
                document.getElementById('payment-loading').style.display = 'block';
                break;
                
            case 'pending':
                document.getElementById('payment-pending').style.display = 'block';
                break;
                
            case 'success':
                document.getElementById('payment-success').style.display = 'block';
                if (data.orderNumber) {
                    document.getElementById('success-order-number').textContent = data.orderNumber;
                }
                if (data.receipt) {
                    document.getElementById('success-receipt').textContent = data.receipt;
                }
                break;
                
            case 'failed':
                document.getElementById('payment-failed').style.display = 'block';
                if (message) {
                    document.getElementById('failed-message').textContent = message;
                }
                document.getElementById('modal-close-btn').style.display = 'block';
                break;
        }
    }

    function showMessage(text, type = 'info') {
        const alertClass = type === 'error' ? 'alert-danger' : `alert-${type}`;
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${text}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        `;
        
        const container = document.querySelector('.checkout-page-wrapper .container');
        if (container) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = alertHtml;
            container.insertBefore(tempDiv.firstElementChild, container.firstElementChild);
            
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }
    }

    function getCSRFToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        return token ? token.value : '';
    }

    function debug(message, data = null) {
        if (debugEnabled) {
            console.log('[Checkout]', message, data || '');
        }
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeCheckout);
    } else {
        initializeCheckout();
    }
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
